<html>
<head>
<style>
body {
	margin: 0px;
}

</style>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/processing.js"></script>
<script type="application/processing" data-processing-target="canvas1">
long frame = 0;
float ang = 0;
float gridSize = 5; // number of columns along both x and y axes in the grid
float unitSpace = 300;
float wallLength = (2 * gridSize + 1) * unitSpace;
float wallHeight = unitSpace * 1.6;

float cameraSpeed = 15;
float cameraX = 3 * unitSpace, cameraZ  = 3 * unitSpace, cameraAngle = -HALF_PI, targetCameraAngle = -HALF_PI;
float camCenterX = 0, camCenterZ = 0;

int[][] upRightDownLeft = [[0,-1],[1,0],[0,1],[-1,0]];
int directionIndex = 0;

GrowthTurn turn; 

void setup() {
  size(document.body.clientWidth, document.body.clientHeight, P3D);
  frameRate(50);
  noStroke();
}

void draw() {
  background(0);
  frame++;

  moveCamera();
  lights();

  for (int x = 0; x < gridSize; x++) {
    for (int y = 0; y < gridSize; y++) {
      drawInnerWall(x,y);
    }
  }

  drawOuterWall();
 
  funThings();

}

void funThings(){
  fill(10, 120, 185);
  stroke(51, 204, 255);
  
  translate(width / 2, height / 2, 100);
  rotateX(0.4 + ang);
  rotateY(0.5 + ang);
  ang = ang + 0.01;
  box(100);

  
  rotateZ(0.6 + ang);
  translate(sin(ang) * 100, 50, 200);

  fill(185, 120, 10);
  stroke(255, 51, 51);

  box(50);
}

void moveCamera() {
  float radius = unitSpace;

  if (turn && !turn.doneTurning) {
    cameraAngle = turn.valueAtNextFrame()
  }

  float theta = cameraAngle;

  camCenterX = radius * cos(theta) + cameraX;
  camCenterZ = radius * sin(theta) + cameraZ;

  camera(cameraX, wallHeight, cameraZ, camCenterX, wallHeight, camCenterZ, 0, 1, 0);
}

void changeDirection(float angle) {
  
  turn = new GrowthTurn(cameraAngle, targetCameraAngle + angle)
  targetCameraAngle = targetCameraAngle + angle
}

void drawInnerWall(int x, int y) {
  pushMatrix();
  translate((2 * x + 1) * unitSpace, height/2, -(2 * y + 1) * unitSpace);

  fill(10, 120, 185);
  stroke(51, 204, 255);
  
  box(unitSpace, wallHeight, unitSpace);
  popMatrix();
}

void drawOuterWall() {
  pushMatrix();
  translate(-unitSpace, 0, -unitSpace);
  rotateY(HALF_PI);
  rect(0, 0, wallLength, wallHeight)
  popMatrix()
}

void keyPressed() {
  frameMovedAt = frame
  if (key == 'w') {
    cameraX = cameraX + upRightDownLeft[directionIndex][0] * cameraSpeed
    cameraZ = cameraZ + upRightDownLeft[directionIndex][1] * cameraSpeed
  }
  if (key == 's') {
    cameraX = cameraX - upRightDownLeft[directionIndex][0] * cameraSpeed
    cameraZ = cameraZ - upRightDownLeft[directionIndex][1] * cameraSpeed 
  }
  if (key == 'a') {
    directionIndex = directionIndex - 1;
    if (directionIndex < 0) {
      directionIndex = 3;
    }
    changeDirection(-HALF_PI);
  }
  if (key == 'd') {
    directionIndex++;
    if (directionIndex > 3) {
      directionIndex = 0;
    }
    changeDirection(HALF_PI);
  }
}

class GrowthTurn {

  float start = 0, end = 0;
  int frame = 0;
  boolean doneTurning = false;

  GrowthTurn(float _start, float _end) {
    start = _start;
    end = _end;
  }

  float valueAtNextFrame() {
    float growth = 1.01 * (frame/2 - 2)/sqrt(pow(frame/2 - 2, 2) + 1);
    float value = growth * end + ((start+end)/2)*(1-growth);
    frame++;
    doneTurning = abs(value - end) < 0.01;
    return doneTurning ? end : value;

  }
}

</script>
<script type="text/javascript">
$(function() {
  $("#canvas1").focus()
});
</script>
</head>
<body>

<canvas id="canvas1" tabindex="1"></canvas>
</body>
</html>